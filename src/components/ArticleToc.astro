---
import type { Locale } from '../config/affiliate';

interface HeadingItem {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  locale: Locale;
  headings: HeadingItem[];
}

const { locale, headings } = Astro.props;

const tocHeadings = headings.filter((item) => item.depth === 2 || item.depth === 3);
const title = locale === 'fr' ? 'Table des matieres' : 'Table of Contents';
---

{
  tocHeadings.length > 0 && (
    <nav class="rounded-2xl border border-dark-700 bg-dark-800 p-5 lg:sticky lg:top-24" aria-label={title}>
      <h3 class="text-white font-bold mb-3">{title}</h3>
      <ul class="space-y-2 text-sm">
        {tocHeadings.map((item) => (
          <li class={item.depth === 3 ? 'pl-3' : ''}>
            <a
              href={`#${item.slug}`}
              data-toc-link={item.slug}
              class="toc-link text-gray-400 hover:text-brand-300 transition-colors block"
            >
              {item.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<script>
  const links = Array.from(document.querySelectorAll('[data-toc-link]')) as HTMLAnchorElement[];
  if (links.length > 0) {
    const sections = links
      .map((link) => {
        const id = link.getAttribute('data-toc-link');
        return id ? document.getElementById(id) : null;
      })
      .filter(Boolean) as HTMLElement[];

    const setActive = (id: string) => {
      links.forEach((link) => {
        const match = link.getAttribute('data-toc-link') === id;
        link.classList.toggle('text-brand-300', match);
        link.classList.toggle('font-semibold', match);
        link.classList.toggle('text-gray-400', !match);
      });
    };

    if (sections.length > 0) {
      const observer = new IntersectionObserver(
        (entries) => {
          const visible = entries
            .filter((entry) => entry.isIntersecting)
            .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);
          if (visible.length > 0) {
            setActive(visible[0].target.id);
          }
        },
        { rootMargin: '-25% 0px -65% 0px', threshold: [0, 1] },
      );

      sections.forEach((section) => observer.observe(section));
      setActive(sections[0].id);
    }
  }
</script>
