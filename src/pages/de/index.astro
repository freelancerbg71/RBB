---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { CATEGORY_NAMES, type Locale } from '../../config/affiliate';
import { getDefaultHeroImageForPost } from '../../utils/blog-hero';
import { isTranslationApproved } from '../../utils/translation-review';

function slugifyCategory(input: string): string {
  return input.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
}

const locale: Locale = 'de';

const allPosts = await getCollection('blog', ({ data }) => {
  return data.locale === locale && data.postType === 'guide' && isTranslationApproved(data);
});

const guideCount = allPosts.length;
const providerCount = new Set(allPosts.map((p) => p.data.gameProvider).filter(Boolean)).size;

const featuredPosts = allPosts.filter((post) => post.data.featured).slice(0, 3);
const recentPosts = allPosts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 7);

const categories = [
  { slug: 'slots', icon: '777' },
  { slug: 'crash-games', icon: 'Aviator' },
  { slug: 'live-casino', icon: 'Live' },
  { slug: 'table-games', icon: 'Cards' },
  { slug: 'strategy', icon: 'Tips' },
].filter((cat) => allPosts.some((p) => slugifyCategory(p.data.category) === cat.slug));

const heroText = {
  badge: 'Redaktionelles Lernzentrum',
  title: 'Spielen Sie intelligenter, indem Sie das System lesen',
  subtitle: 'Spielmechaniken, Quotenkontext und Strategieanalysen in klarer Sprache. Klarer Kontext. Echte Muster.',
  primaryCta: 'Alle Anleitungen ansehen',
  secondaryCta: 'Neueste Analysen',
  panelTitle: 'Was zuerst gelesen wird',
  stats: {
    guides: guideCount.toString(),
    guidesLabel: 'Anleitungen',
    providers: providerCount.toString(),
    providersLabel: 'Anbieter',
    educational: '100%',
    educationalLabel: 'Bildung',
  },
  browseByCategory: 'Nach Thema durchsuchen',
  featuredGuides: 'Empfehlungen der Redaktion',
  featuredSubtitle: 'Erklärungen mit hohem Nutzen, mit denen Sie beginnen sollten.',
  latestGuides: 'Neue Anleitungen',
  latestSubtitle: 'Die neuesten Erklärungen und Updates.',
  ctaTitle: 'Beginnen Sie mit einer Anleitung. Gehen Sie mit einem besseren Filter.',
  ctaSubtitle: 'Lernen Sie, wie Sie Mechaniken und Risiken lesen, bevor Sie wetten. Bauen Sie einen Prozess auf, keinen Aberglauben.',
  ctaButton: 'Anleitungen lesen',
  viewAll: 'Alle ansehen',
  geoNote: 'Unterliegt lokalen Glücksspielgesetzen und -vorschriften.',
};

const seo = {
  title: 'Read Between Bets | Bildungsleitfäden für Casinospiele',
  description: 'Lernen Sie mit unseren Bildungsleitfäden in klarer Sprache, wie Casinospiele funktionieren - Mechaniken, Strategie und Risikokontext.',
};

const h = heroText;
const heroPanelPosts = recentPosts.slice(0, 3);
const latestLead = recentPosts[0];
const latestGrid = recentPosts.slice(1, 7);
---

<Layout title={seo.title} description={seo.description} locale={locale} alternates={{ en: '/', fr: '/fr/', de: '/de/', ru: '/ru/' }}>
  <section class="relative overflow-hidden border-b border-white/10">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_74%_5%,rgba(236,72,153,0.26),transparent_32%),radial-gradient(circle_at_0%_100%,rgba(251,191,36,0.14),transparent_28%)]"></div>
    <div class="relative section-padding max-w-7xl mx-auto py-14 sm:py-16 lg:py-20">
      <div class="grid gap-10 lg:grid-cols-[1.25fr_0.75fr] lg:items-center">
        <div>
          <p class="eyebrow mb-5">{h.badge}</p>
          <h1 class="font-display text-4xl sm:text-5xl lg:text-6xl leading-[1.06] text-white max-w-2xl headline-balance">
            {h.title}
          </h1>
          <p class="mt-6 text-base sm:text-lg text-gray-300 max-w-xl">
            {h.subtitle}
          </p>

          <div class="mt-8 flex flex-wrap gap-3">
            <a href={'/de/blog'} class="btn-primary">
              {h.primaryCta}
            </a>
            <a href={'/de/blog/insights'} class="btn-outline">
              {h.secondaryCta}
            </a>
          </div>

          <div class="mt-10 grid gap-5 sm:grid-cols-3">
            <div class="rounded-xl border border-white/10 bg-white/5 px-4 py-4">
              <p class="text-2xl font-display text-white">{h.stats.guides}</p>
              <p class="text-xs uppercase tracking-[0.14em] text-gray-400 mt-1">{h.stats.guidesLabel}</p>
            </div>
            <div class="rounded-xl border border-white/10 bg-white/5 px-4 py-4">
              <p class="text-2xl font-display text-white">{h.stats.providers}</p>
              <p class="text-xs uppercase tracking-[0.14em] text-gray-400 mt-1">{h.stats.providersLabel}</p>
            </div>
            <div class="rounded-xl border border-white/10 bg-white/5 px-4 py-4">
              <p class="text-2xl font-display text-white">{h.stats.educational}</p>
              <p class="text-xs uppercase tracking-[0.14em] text-gray-400 mt-1">{h.stats.educationalLabel}</p>
            </div>
          </div>
        </div>

        <aside class="py-6 lg:py-0 lg:pl-10 lg:pr-0 border-l border-white/5 h-full flex flex-col justify-center">
          <p class="eyebrow mb-6 text-gray-400">{h.panelTitle}</p>
          <div class="space-y-6">
            {heroPanelPosts.map((post, index) => (
              <a href={`/de/blog/${post.data.urlSlug}`} class="group flex items-start gap-4 transition-colors">
                <div class="shrink-0 w-8 text-brand-500 font-sans text-xl leading-none pt-0.5">
                  {String(index + 1).padStart(2, '0')}
                </div>
                <div class="min-w-0">
                  <p class="text-gray-300 text-sm font-semibold leading-snug line-clamp-2 group-hover:text-white transition-colors">{post.data.title}</p>
                  <p class="mt-1 text-xs text-brand-500/60 font-sans uppercase tracking-widest">{post.data.category}</p>
                </div>
              </a>
            ))}
          </div>

          <p class="mt-8 text-xs text-gray-500 font-sans border-t border-white/5 pt-4">{h.geoNote}</p>
        </aside>
      </div>
    </div>
  </section>

  <section class="py-12">
    <div class="section-padding max-w-7xl mx-auto">
      <div class="flex items-center justify-between gap-4 mb-6">
        <h2 class="text-2xl sm:text-3xl font-display text-white">{h.browseByCategory}</h2>
      </div>
      <div class="flex flex-wrap gap-3">
        {categories.map((cat) => (
          <a href={`/de/category/${cat.slug}`} class="inline-flex items-center gap-2 rounded-full border border-white/15 bg-white/5 px-4 py-2 text-sm font-semibold text-gray-200 transition-all hover:-translate-y-[1px] hover:border-brand-300/60 hover:text-white">
            <span class="text-brand-300">{cat.icon}</span>
            <span>{CATEGORY_NAMES[cat.slug]?.[locale] || cat.slug}</span>
          </a>
        ))}
      </div>
    </div>
  </section>

  {featuredPosts.length > 0 && (
    <section class="py-8 sm:py-10">
      <div class="section-padding max-w-7xl mx-auto">
        <div class="flex items-end justify-between gap-4 mb-7">
          <div>
            <p class="eyebrow mb-2">{h.featuredGuides}</p>
            <p class="text-gray-300 max-w-2xl">{h.featuredSubtitle}</p>
          </div>
          <a href={'/de/blog'} class="btn-outline hidden sm:inline-flex">{h.viewAll}</a>
        </div>

        <div class="grid gap-12 lg:grid-cols-[1.2fr_0.8fr]">
          <article class="group">
            <a href={`/de/blog/${featuredPosts[0].data.urlSlug}`} class="block">
              <div class="aspect-[16/9] overflow-hidden rounded mb-6">
                <img src={getDefaultHeroImageForPost(featuredPosts[0])} alt={featuredPosts[0].data.title} class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy" />
              </div>
              <div>
                <p class="text-brand-500 font-sans uppercase tracking-widest text-xs mb-3">{featuredPosts[0].data.category}</p>
                <h3 class="text-3xl font-display text-white leading-tight line-clamp-2 group-hover:text-brand-100 transition-colors">{featuredPosts[0].data.title}</h3>
                <p class="mt-4 text-gray-400 line-clamp-2 leading-relaxed text-lg">{featuredPosts[0].data.description}</p>
              </div>
            </a>
          </article>

          <div class="flex flex-col justify-center space-y-8">
            {featuredPosts.slice(1).map((post) => (
              <article class="group">
                <a href={`/de/blog/${post.data.urlSlug}`} class="flex gap-6 items-center">
                  <div class="w-32 h-32 overflow-hidden shrink-0 rounded">
                     <img src={getDefaultHeroImageForPost(post)} alt={post.data.title} class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-500" loading="lazy" />
                  </div>
                  <div class="min-w-0">
                    <p class="text-brand-500 font-sans uppercase tracking-widest text-xs mb-2">{post.data.category}</p>
                    <h3 class="text-xl text-gray-200 font-semibold leading-snug line-clamp-2 group-hover:text-white transition-colors">{post.data.title}</h3>
                  </div>
                </a>
              </article>
            ))}
          </div>
        </div>
      </div>
    </section>
  )}

  <section class="py-14">
    <div class="section-padding max-w-7xl mx-auto">
      <div class="flex items-end justify-between gap-4 mb-7">
        <div>
          <p class="eyebrow mb-2">{h.latestGuides}</p>
          <p class="text-gray-300 max-w-2xl">{h.latestSubtitle}</p>
        </div>
        <a href={'/de/blog'} class="btn-outline hidden sm:inline-flex">{h.viewAll}</a>
      </div>

      <div class="grid gap-12 lg:grid-cols-[1.1fr_0.9fr]">
        {latestLead && (
          <article class="group relative pb-8 border-b border-white/10 lg:border-none lg:pb-0">
            <a href={`/de/blog/${latestLead.data.urlSlug}`} class="block">
              <div class="aspect-[4/3] overflow-hidden rounded mb-6">
                <img src={getDefaultHeroImageForPost(latestLead)} alt={latestLead.data.title} class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy" />
              </div>
              <div>
                <p class="text-brand-500 font-sans uppercase tracking-widest text-xs mb-3">{latestLead.data.category}</p>
                <h3 class="text-3xl font-display text-white leading-tight line-clamp-2 group-hover:text-brand-100 transition-colors">{latestLead.data.title}</h3>
                <p class="mt-4 text-gray-400 line-clamp-3 leading-relaxed text-lg">{latestLead.data.description}</p>
              </div>
            </a>
          </article>
        )}

        <div class="flex flex-col justify-between space-y-8 lg:pl-12 lg:border-l lg:border-white/5">
          {latestGrid.map((post) => (
            <article class="group">
              <a href={`/de/blog/${post.data.urlSlug}`} class="block">
                <p class="text-brand-500 font-sans uppercase tracking-widest text-[10px] mb-2">{post.data.category}</p>
                <h3 class="text-xl text-gray-300 font-semibold leading-snug line-clamp-2 group-hover:text-white transition-colors">{post.data.title}</h3>
                <p class="mt-2 text-sm text-gray-500 font-sans">{post.data.pubDate.toLocaleDateString('de-DE', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
              </a>
            </article>
          ))}
        </div>
      </div>
    </div>
  </section>

  <section class="pb-16 sm:pb-20">
    <div class="section-padding max-w-7xl mx-auto">
      <div class="rounded-3xl border border-brand-300/30 bg-gradient-to-r from-brand-700/45 to-brand-900/45 p-8 sm:p-10 lg:p-12">
        <p class="eyebrow mb-4 text-brand-100">{h.badge}</p>
        <h2 class="text-3xl sm:text-4xl font-display text-white leading-tight">{h.ctaTitle}</h2>
        <p class="mt-4 text-gray-200">{h.ctaSubtitle}</p>
        <div class="mt-8">
          <a href={'/de/blog'} class="btn-primary">{h.ctaButton}</a>
        </div>
      </div>
    </div>
  </section>
</Layout>



