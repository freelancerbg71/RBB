---
import Layout from '../../../layouts/Layout.astro';
import { AFFILIATE_LINKS, CASINO_INFO, type Casino, type Locale } from '../../../config/affiliate';

export function getStaticPaths() {
  const casinos: Casino[] = ['privateclub', 'barbossabet'];
  return casinos.map((casino) => ({ params: { casino } }));
}

const locale: Locale = 'de';
const casino = Astro.params.casino as Casino;
const info = CASINO_INFO[casino];
const outbound = AFFILIATE_LINKS[casino][locale];

const title = `Weiter zu ${info.name} | Read Between Bets`;
const description = `Hinweis zu externem Link fuer ${info.name}. Verfuegbarkeit variiert nach Region.`;

const redirectSeconds = 2;
const outboundEvent = {
  casino,
  locale,
};
---

<Layout title={title} description={description} locale={locale} alternates={{ en: `/go/${casino}/`, de: `/de/go/${casino}/` }} noindex={true}>
  <section class="section-padding max-w-3xl mx-auto py-16">
    <div class="bg-dark-800 rounded-2xl border border-dark-700 p-8">
      <h1 class="text-2xl sm:text-3xl font-bold text-white mb-3">Sie verlassen Read Between Bets</h1>
      <p class="text-gray-300 mb-6">
        Sie wechseln zu <span class="text-white font-semibold">{info.name}</span>. Verfuegbarkeit ist standortabhaengig und kann in einigen Regionen eingeschraenkt sein.
      </p>

      <div class="bg-dark-900 rounded-xl border border-dark-700 p-4 mb-6">
        <p class="text-gray-400 text-sm">
          Einige Links auf dieser Website sind Affiliate-Links. Bei Registrierung und Einzahlung koennen wir eine Provision erhalten.
        </p>
      </div>

      <p class="text-gray-400 text-sm mb-6">
        Automatische Weiterleitung in <span id="countdown" class="text-white font-semibold">{redirectSeconds}</span> Sekunden.
      </p>

      <div class="flex flex-col sm:flex-row gap-3">
        <a
          id="continue-outbound"
          href={outbound}
          rel="sponsored nofollow"
          class="inline-flex items-center justify-center px-5 py-3 rounded-lg bg-brand-500 hover:bg-brand-600 text-white font-semibold transition-colors"
        >
          Weiter
        </a>
        <a
          id="cancel-outbound"
          href="/de/"
          class="inline-flex items-center justify-center px-5 py-3 rounded-lg bg-dark-700 hover:bg-dark-600 text-gray-200 font-semibold transition-colors"
        >
          Zurueck
        </a>
      </div>
    </div>
  </section>
</Layout>

<script is:inline define:vars={{ redirectSeconds, outbound, outboundEvent }}>
  (() => {
    const track = (action) => {
      const detail = { ...outboundEvent, action };
      window.dispatchEvent(new CustomEvent('rbb:outbound', { detail }));
      if (typeof window.plausible === 'function') {
        window.plausible('Outbound Click', { props: detail });
      }
    };

    const continueLink = document.getElementById('continue-outbound');
    const cancelLink = document.getElementById('cancel-outbound');
    continueLink?.addEventListener('click', () => track('manual_continue'));
    cancelLink?.addEventListener('click', () => track('cancel'));

    const seconds = Number(redirectSeconds);
    const el = document.getElementById('countdown');
    if (!Number.isFinite(seconds) || seconds <= 0) return;

    let remaining = seconds;
    const render = () => {
      if (el) el.textContent = String(Math.max(0, remaining));
    };

    render();

    const timer = window.setInterval(() => {
      remaining -= 1;
      render();
      if (remaining <= 0) {
        window.clearInterval(timer);
        track('auto_redirect');
        window.location.href = outbound;
      }
    }, 1000);
  })();
</script>
