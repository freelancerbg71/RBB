---
import Layout from '../../../layouts/Layout.astro';
import AffiliateCard from '../../../components/AffiliateCard.astro';
import { UI_TEXT, CTA_TEXT, type Casino, type Locale } from '../../../config/affiliate';

const locale: Locale = 'de';
const title = 'Krypto-Gebühren-Rechner | Read Between Bets';
const description = 'Vergleichen Sie BTC, LTC, ERC20 und TRC20, um Verluste durch Gebühren vor der Einzahlung zu begrenzen.';
const ui = UI_TEXT[locale];
const cta = CTA_TEXT[locale];
const casinos: Casino[] = ['privateclub', 'barbossabet'];
---

<Layout title={title} description={description} locale={locale} alternates={{ en: '/tools/fee-impact/', de: '/de/tools/impact-frais/' }}>
  <section class="relative py-16 border-b border-dark-700">
    <div class="section-padding max-w-5xl mx-auto">
      <p class="eyebrow mb-4">Einzahlungswert</p>
      <h1 class="text-4xl sm:text-5xl font-bold text-white mb-4">Krypto-Gebühren-Rechner</h1>
      <p class="text-lg text-gray-300 max-w-3xl">
        Vergleichen Sie die tatsächlichen Kosten einer Einzahlung in den meistgenutzten Krypto-Netzwerken.
      </p>
    </div>
  </section>

  <section class="py-12">
    <div class="section-padding max-w-5xl mx-auto space-y-6">
      <article class="p-6 md:p-8 border border-dark-700 rounded-xl">
        <form id="fee-form-de" class="grid md:grid-cols-[2fr,1fr] gap-4 items-end">
          <label class="block">
            <span class="text-sm text-gray-300">Einzahlungsbetrag (USD)</span>
            <input id="deposit-amount-de" type="number" min="10" step="5" value="100" class="mt-1 w-full rounded-lg border border-dark-700 bg-dark-900 px-3 py-2 text-white" />
          </label>
          <button id="refresh-fees-de" type="button" class="btn-primary">Live-BTC-Gebühren aktualisieren</button>
        </form>
        <p id="last-updated-de" class="text-xs text-gray-500 mt-3">Geschätzte Werte, solange keine Live-Daten geladen wurden.</p>
        <p class="text-xs text-gray-500 mt-1">
          Live-Quelle für BTC-Gebühren:
          <a href="https://mempool.space/" target="_blank" rel="noopener noreferrer" class="text-brand-300 hover:text-brand-200 underline">API mempool.space</a>
        </p>
      </article>

      <article class="p-6 md:p-8 border border-dark-700 rounded-xl">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead>
              <tr class="text-gray-400 border-b border-dark-700">
                <th class="py-3 pr-3">Netzwerk</th>
                <th class="py-3 pr-3">Gebühren (USD)</th>
                <th class="py-3 pr-3">Sie zahlen ein</th>
                <th class="py-3 pr-3">Sie spielen mit</th>
                <th class="py-3">Verlust %</th>
              </tr>
            </thead>
            <tbody id="fee-table-body-de">
              <tr data-network="BTC" class="border-b border-dark-800">
                <td class="py-3 pr-3">Bitcoin (BTC)</td>
                <td class="py-3 pr-3">
                  $ <input id="btc-fee-input-de" type="number" value="6.00" min="0" step="0.1" aria-label="Bitcoin-Gebühr in USD" class="fee-input-de w-24 rounded border border-dark-700 bg-dark-900 px-2 py-1 text-white" />
                  <div id="btc-details-de" class="text-xs text-gray-500 mt-1">Geschätzter Standardwert</div>
                </td>
                <td class="deposit-amt-de py-3 pr-3">$100</td>
                <td class="play-amt-de py-3 pr-3 text-white">--</td>
                <td class="fee-percent-de py-3">--</td>
              </tr>
              <tr data-network="LTC" class="border-b border-dark-800">
                <td class="py-3 pr-3">Litecoin (LTC)</td>
                <td class="py-3 pr-3">$ <input type="number" value="0.05" min="0" step="0.01" aria-label="Litecoin-Gebühr in USD" class="fee-input-de w-24 rounded border border-dark-700 bg-dark-900 px-2 py-1 text-white" /></td>
                <td class="deposit-amt-de py-3 pr-3">$100</td>
                <td class="play-amt-de py-3 pr-3 text-white">--</td>
                <td class="fee-percent-de py-3">--</td>
              </tr>
              <tr data-network="ERC20" class="border-b border-dark-800">
                <td class="py-3 pr-3">Ethereum (ERC20)</td>
                <td class="py-3 pr-3">$ <input type="number" value="4.50" min="0" step="0.1" aria-label="Ethereum ERC20-Gebühr in USD" class="fee-input-de w-24 rounded border border-dark-700 bg-dark-900 px-2 py-1 text-white" /></td>
                <td class="deposit-amt-de py-3 pr-3">$100</td>
                <td class="play-amt-de py-3 pr-3 text-white">--</td>
                <td class="fee-percent-de py-3">--</td>
              </tr>
              <tr data-network="TRC20">
                <td class="py-3 pr-3">Tron (TRC20)</td>
                <td class="py-3 pr-3">$ <input type="number" value="1.00" min="0" step="0.1" aria-label="Tron TRC20-Gebühr in USD" class="fee-input-de w-24 rounded border border-dark-700 bg-dark-900 px-2 py-1 text-white" /></td>
                <td class="deposit-amt-de py-3 pr-3">$100</td>
                <td class="play-amt-de py-3 pr-3 text-white">--</td>
                <td class="fee-percent-de py-3">--</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="mt-6 border-l-2 border-brand-400 pl-4">
          <p class="text-sm text-brand-300 font-semibold mb-1">Empfehlung</p>
          <p id="fee-recommendation-de" class="text-sm text-gray-300">--</p>
        </div>

        <p class="text-xs text-gray-500 mt-4">
          Nur zur Information. Die tatsächlichen Gebühren hängen vom Wallet, der Börse und dem Netzwerk ab.
        </p>
      </article>

      <article class="p-6 md:p-8 border border-dark-700 rounded-xl bg-dark-800">
        <h2 class="text-2xl font-bold text-white mb-2">{ui.whereToPlay}</h2>
        <p class="text-gray-400 text-sm mb-2">{ui.availabilityNote}</p>
        <p class="text-gray-500 text-xs mb-2">{ui.availabilityWarning}</p>
        <p class="text-gray-500 text-xs mb-6">{cta.affiliateDisclosure}</p>

        <div class="grid gap-4 md:grid-cols-2">
          {casinos.map((casinoKey) => (
            <AffiliateCard
              casinoKey={casinoKey}
              locale={locale}
              href={`/de/go/${casinoKey}`}
              ctaLabel={cta.seeAvailability}
            />
          ))}
        </div>
      </article>
    </div>
  </section>
</Layout>

<script>
  const BTC_CACHE_KEY_DE = 'rbb:btc-fee-cache:de';
  const BTC_CACHE_TTL_MS_DE = 5 * 60 * 1000;

  const formatNumberDe = (value: number, digits = 0) =>
    new Intl.NumberFormat('de-DE', {
      maximumFractionDigits: digits,
      minimumFractionDigits: digits
    }).format(value);

  const updateCalculationsDe = () => {
    const deposit = Math.max(1, Number.parseFloat((document.getElementById('deposit-amount-de') as HTMLInputElement).value) || 0);
    const rows = document.querySelectorAll('#fee-table-body-de tr');

    let best = { net: -Infinity, network: '', percent: 0 };

    rows.forEach((row) => {
      (row.querySelector('.deposit-amt-de') as HTMLElement).textContent = `$${formatNumberDe(deposit)}`;

      const feeInput = row.querySelector('.fee-input-de') as HTMLInputElement;
      const fee = Math.max(0, Number.parseFloat(feeInput.value) || 0);
      const net = Math.max(0, deposit - fee);
      const percent = deposit > 0 ? (fee / deposit) * 100 : 0;

      (row.querySelector('.play-amt-de') as HTMLElement).textContent = `$${formatNumberDe(net, 2)}`;

      const pctCell = row.querySelector('.fee-percent-de') as HTMLElement;
      pctCell.textContent = `${formatNumberDe(percent, 2)}%`;
      pctCell.classList.remove('text-red-400', 'text-green-400', 'text-gray-400');
      if (percent > 10) pctCell.classList.add('text-red-400');
      else if (percent < 2) pctCell.classList.add('text-green-400');
      else pctCell.classList.add('text-gray-400');

      if (net > best.net) {
        best = { net, network: row.getAttribute('data-network') ?? '', percent };
      }
    });

    const rec = document.getElementById('fee-recommendation-de') as HTMLElement;
    if (best.percent > 5) {
      rec.textContent = `Die Gebühren sind hoch. Selbst mit ${best.network}, verlieren Sie ${formatNumberDe(best.percent, 1)}% bei diesem Betrag.`;
    } else {
      rec.textContent = `Wählen Sie ${best.network} um mehr zu behalten. Sie behalten $${formatNumberDe(best.net, 2)} von $${formatNumberDe(deposit)}.`;
    }
  };

  const fetchJsonWithTimeoutDe = async (url: string, timeoutMs: number) => {
    const controller = new AbortController();
    const timeout = window.setTimeout(() => controller.abort(), timeoutMs);
    try {
      const response = await fetch(url, { signal: controller.signal });
      return response;
    } finally {
      window.clearTimeout(timeout);
    }
  };

  const readCachedBtcDe = () => {
    try {
      const raw = localStorage.getItem(BTC_CACHE_KEY_DE);
      if (!raw) return null;
      const parsed = JSON.parse(raw) as { feeUsd: number; satByte: number; btcPrice: number; ts: number };
      if (!Number.isFinite(parsed.feeUsd) || !Number.isFinite(parsed.ts)) return null;
      return parsed;
    } catch {
      return null;
    }
  };

  const writeCachedBtcDe = (feeUsd: number, satByte: number, btcPrice: number) => {
    try {
      localStorage.setItem(
        BTC_CACHE_KEY_DE,
        JSON.stringify({ feeUsd, satByte, btcPrice, ts: Date.now() }),
      );
    } catch {
      // Ignore storage quota/privacy mode failures.
    }
  };

  const fetchLiveBtcFeeDe = async () => {
    const button = document.getElementById('refresh-fees-de') as HTMLButtonElement;
    const status = document.getElementById('last-updated-de') as HTMLElement;
    const btcInput = document.getElementById('btc-fee-input-de') as HTMLInputElement;
    const btcDetails = document.getElementById('btc-details-de') as HTMLElement;

    button.disabled = true;
    button.textContent = 'Wird geladen...';

    try {
      const [priceRes, feeRes] = await Promise.all([
        fetchJsonWithTimeoutDe('https://mempool.space/api/v1/prices', 8000),
        fetchJsonWithTimeoutDe('https://mempool.space/api/v1/fees/recommended', 8000)
      ]);

      if (!priceRes.ok || !feeRes.ok) {
        throw new Error('Live fee fetch failed');
      }

      const priceData = await priceRes.json() as { USD?: number };
      const feeData = await feeRes.json() as { halfHourFee?: number };

      const btcPrice = Number(priceData.USD);
      const satByte = Number(feeData.halfHourFee);
      if (!Number.isFinite(btcPrice) || !Number.isFinite(satByte)) {
        throw new Error('Invalid fee response');
      }

      const txSizeVbytes = 140;
      const feeUsd = ((satByte * txSizeVbytes) / 100000000) * btcPrice;

      btcInput.value = feeUsd.toFixed(2);
      btcDetails.textContent = `${formatNumberDe(satByte, 0)} sat/vB, BTC ~$${formatNumberDe(btcPrice, 0)}`;
      status.textContent = `Aktualisiert ${new Date().toLocaleTimeString('de-DE')}`;
      writeCachedBtcDe(feeUsd, satByte, btcPrice);
    } catch {
      const cached = readCachedBtcDe();
      if (cached && Date.now() - cached.ts <= BTC_CACHE_TTL_MS_DE) {
        btcInput.value = cached.feeUsd.toFixed(2);
        btcDetails.textContent = `${formatNumberDe(cached.satByte, 0)} sat/vB, BTC ~$${formatNumberDe(cached.btcPrice, 0)} (cache)`;
        status.textContent = 'Live-Fehler. Kürzlich zwischengespeicherte Werte verwendet.';
      } else {
        status.textContent = 'Live-Fehler. Manuelle/geschätzte Werte verwendet.';
        btcDetails.textContent = 'mempool.space konnte nicht geladen werden';
      }
    } finally {
      button.disabled = false;
      button.textContent = 'Live-BTC-Gebühren aktualisieren';
      updateCalculationsDe();
    }
  };

  document.querySelectorAll('.fee-input-de').forEach((input) => {
    input.addEventListener('input', updateCalculationsDe);
  });
  document.getElementById('deposit-amount-de')?.addEventListener('input', updateCalculationsDe);
  document.getElementById('refresh-fees-de')?.addEventListener('click', fetchLiveBtcFeeDe);

  updateCalculationsDe();
  fetchLiveBtcFeeDe();
</script>

