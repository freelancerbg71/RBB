---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { UI_TEXT, getCategoryName, type Locale } from '../../config/affiliate';
import { getDefaultHeroImageForPost } from '../../utils/blog-hero';
import { isTranslationApproved } from '../../utils/translation-review';

function slugifyCategory(input: string): string {
  return input.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
}

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => (data.locale ?? 'en') === 'en' && data.postType === 'guide');
  const seen = new Set<string>();
  for (const p of posts) {
    if (!p.data.category) continue;
    // Define locally to avoid any build-time hoisting edge cases.
    const toSlug = (input: string) =>
      input.toLowerCase().trim().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    seen.add(toSlug(p.data.category));
  }
  const preferredOrder = ['slots', 'crash-games', 'live-casino', 'table-games', 'strategy'];
  const categorySlugs = preferredOrder.filter((s) => seen.has(s)).concat([...seen].filter((s) => !preferredOrder.includes(s)));

  const paths = [];
  for (const category of categorySlugs) {
    paths.push({
      params: { category },
      props: { locale: 'en' },
    });
  }

  return paths;
}

const categorySlug = Astro.params.category!;
const { locale } = Astro.props as { locale: Locale };
const basePrefix = locale === 'en' ? '' : `/${locale}`;

const allPosts = await getCollection(
  'blog',
  ({ data }) => data.locale === locale && data.postType === 'guide' && isTranslationApproved(data),
);

const categoryPosts = allPosts
  .filter((post) => slugifyCategory(post.data.category) === categorySlug)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const seenCategorySlugs = new Set(allPosts.map((p) => slugifyCategory(p.data.category)));
const preferredOrder = ['slots', 'crash-games', 'live-casino', 'table-games', 'strategy'];
const allCategories = preferredOrder.filter((s) => seenCategorySlugs.has(s)).concat([...seenCategorySlugs].filter((s) => !preferredOrder.includes(s)));
const ui = UI_TEXT[locale];

const infoBySlug: Record<string, { title: string; description: string; icon: string }> = {
  'crash-games': {
    title: 'Crash Game Guides',
    description: 'Educational guides explaining how crash games work, including mechanics and features.',
    icon: 'Crash',
  },
  'slots': {
    title: 'Slot Game Guides',
    description: 'Educational guides explaining how slot games work, from mechanics to bonus features.',
    icon: 'Slots',
  },
  'live-casino': {
    title: 'Live Casino Guides',
    description: 'Educational guides explaining how live dealer games work.',
    icon: 'Live',
  },
  'table-games': {
    title: 'Table Game Guides',
    description: 'Educational guides explaining how casino table games work.',
    icon: 'Table',
  },
  'strategy': {
    title: 'Casino Strategy Guides',
    description: 'Educational guides about bankroll and understanding casino game mechanics.',
    icon: 'Strategy',
  },
};

const info = infoBySlug[categorySlug] ?? {
  title: getCategoryName(categorySlug, locale),
  description: `Educational guides explaining how ${getCategoryName(categorySlug, locale)} work.`,
  icon: getCategoryName(categorySlug, locale),
};

const tByLocale = {
  en: {
    guidesAvailable: 'guides available',
    noGuides: 'No guides yet in this category',
    checkBack: 'Check back soon for new content!',
    categories: 'Categories:',
  },
  fr: {
    guidesAvailable: 'guides disponibles',
    noGuides: 'Pas encore de guides dans cette categorie',
    checkBack: 'Revenez bientot pour du nouveau contenu.',
    categories: 'Categories :',
  },
  de: {
    guidesAvailable: 'Leitfaeden verfuegbar',
    noGuides: 'Noch keine Leitfaeden in dieser Kategorie',
    checkBack: 'Schauen Sie bald wieder vorbei.',
    categories: 'Kategorien:',
  },
  ru: {
    guidesAvailable: 'guides available',
    noGuides: 'No guides yet in this category',
    checkBack: 'Check back soon for new content.',
    categories: 'Categories:',
  },
} as const;
const t = tByLocale[locale] ?? tByLocale.en;
const dateLocale = locale === 'fr' ? 'fr-FR' : locale === 'de' ? 'de-DE' : locale === 'ru' ? 'ru-RU' : 'en-US';
---

<Layout
  title={`${info.title} | Read Between Bets`}
  description={info.description}
  locale={locale}
  alternates={{
    en: `/category/${categorySlug}/`,
    fr: `/fr/category/${categorySlug}/`,
    de: `/de/category/${categorySlug}/`,
    ru: `/ru/category/${categorySlug}/`,
  }}
>
  <section class="relative py-16 bg-dark-800/50 border-b border-dark-700">
    <div class="section-padding max-w-7xl mx-auto">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
        <div>
          <div class="flex items-center gap-3 mb-4">
            <span class="text-4xl">{info.icon}</span>
            <h1 class="text-4xl sm:text-5xl font-bold text-white">{info.title}</h1>
          </div>
          <p class="text-gray-400 text-lg max-w-2xl">{info.description}</p>
          <p class="text-brand-400 text-sm mt-2">{categoryPosts.length} {t.guidesAvailable}</p>
        </div>
      </div>
    </div>
  </section>

  <section class="py-6 border-b border-dark-700 sticky top-16 lg:top-20 bg-dark-900/95 backdrop-blur-md z-40">
    <div class="section-padding max-w-7xl mx-auto">
      <div class="flex items-center gap-4 overflow-x-auto pb-2 scrollbar-hide">
        <span class="text-gray-500 text-sm whitespace-nowrap">{t.categories}</span>
        <a
          href={`${basePrefix}/blog`}
          class="px-4 py-2 rounded-full bg-dark-800 text-gray-300 hover:text-white text-sm font-medium whitespace-nowrap border border-dark-700 hover:border-brand-500/50 transition-colors"
        >
          {ui.all}
        </a>
        {allCategories.map((catSlug) => {
          const isActive = catSlug === categorySlug;
          return (
            <a
              href={`${basePrefix}/category/${catSlug}`}
              class={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap border transition-colors ${
                isActive
                  ? 'bg-brand-500 text-white border-brand-500'
                  : 'bg-dark-800 text-gray-300 hover:text-white border-dark-700 hover:border-brand-500/50'
              }`}
            >
              {getCategoryName(catSlug, locale)}
            </a>
          );
        })}
      </div>
    </div>
  </section>

  <section class="py-12">
    <div class="section-padding max-w-7xl mx-auto">
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {categoryPosts.map((post) => (
          <article class="group relative flex flex-col cursor-pointer pb-6 border-b border-light/5 lg:border-none lg:pb-0">
            <a href={`${basePrefix}/blog/${post.data.urlSlug}`} class="block w-full">
              <div class="aspect-[4/3] bg-dark-800 relative overflow-hidden mb-5 rounded">
                <img
                  src={getDefaultHeroImageForPost(post)}
                  alt={post.data.title}
                  class="w-full h-full object-cover scale-100 group-hover:scale-105 transition-transform duration-700"
                  loading="lazy"
                />
                {post.data.featured && (
                  <div class="absolute top-4 left-4">
                    <span class="px-3 py-1 bg-white text-dark-900 text-[10px] uppercase tracking-widest font-bold">
                      {ui.featured}
                    </span>
                  </div>
                )}
              </div>
            </a>
            <div class="flex-1 flex flex-col">
              <div class="flex items-center gap-2 mb-3 flex-wrap">
                <span class="text-brand-500 font-sans text-[10px] uppercase tracking-widest">
                  {getCategoryName(categorySlug, locale)}
                </span>
                {post.data.rtp && (
                  <span class="text-gray-500 font-sans text-[10px] uppercase tracking-widest border-l border-gray-700 pl-2">RTP {post.data.rtp}</span>
                )}
                {post.data.gameProvider && (
                  <span class="text-gray-500 font-sans text-[10px] uppercase tracking-widest border-l border-gray-700 pl-2">{post.data.gameProvider}</span>
                )}
              </div>
              <a href={`${basePrefix}/blog/${post.data.urlSlug}`} class="block mb-3">
                <h2 class="text-xl font-semibold text-gray-200 group-hover:text-white transition-colors line-clamp-2 leading-snug">{post.data.title}</h2>
              </a>
              <p class="text-gray-400 text-sm line-clamp-3 mb-6 flex-1 leading-relaxed">{post.data.description}</p>
              <div class="flex items-center justify-between text-xs font-sans text-gray-500 pt-4 border-t border-dark-700">
                <span class="uppercase tracking-wider">{post.data.author}</span>
                <span>
                  {post.data.pubDate.toLocaleDateString(dateLocale, {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                  })}
                </span>
              </div>
            </div>
          </article>
        ))}
      </div>

      {categoryPosts.length === 0 && (
        <div class="text-center py-20">
          <div class="text-6xl mb-4">Docs</div>
          <h3 class="text-xl font-bold text-white mb-2">{t.noGuides}</h3>
          <p class="text-gray-400">{t.checkBack}</p>
        </div>
      )}
    </div>
  </section>
</Layout>

<style>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
