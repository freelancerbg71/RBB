---
import Layout from '../../layouts/Layout.astro';
import AffiliateCard from '../../components/AffiliateCard.astro';
import { UI_TEXT, CTA_TEXT, type Casino, type Locale } from '../../config/affiliate';

const locale: Locale = 'en';
const title = 'Crypto Fee Converter | Read Between Bets';
const description = 'Compare BTC, LTC, ERC20, and TRC20 fee drag before you deposit.';
const ui = UI_TEXT[locale];
const cta = CTA_TEXT[locale];
const casinos: Casino[] = ['privateclub', 'barbossabet'];
---

<Layout title={title} description={description} locale={locale} alternates={{ en: '/tools/fee-impact/', fr: '/fr/tools/impact-frais/' }}>
  <section class="relative py-16 border-b border-dark-700">
    <div class="section-padding max-w-5xl mx-auto">
      <p class="eyebrow mb-4">Payout Value</p>
      <h1 class="text-4xl sm:text-5xl font-bold text-white mb-4">Crypto Fee Converter</h1>
      <p class="text-lg text-gray-300 max-w-3xl">
        Compare the real cost of depositing across common crypto networks.
      </p>
    </div>
  </section>

  <section class="py-12">
    <div class="section-padding max-w-5xl mx-auto space-y-6">
      <article class="p-6 md:p-8 border border-dark-700 rounded-xl">
        <form id="fee-form" class="grid md:grid-cols-[2fr,1fr] gap-4 items-end">
          <label class="block">
            <span class="text-sm text-gray-300">Deposit amount (USD)</span>
            <input id="deposit-amount" type="number" min="10" step="5" value="100" class="mt-1 w-full rounded-lg border border-dark-700 bg-dark-900 px-3 py-2 text-white" />
          </label>
          <button id="refresh-fees" type="button" class="btn-primary">Refresh live BTC fee</button>
        </form>
        <p id="last-updated" class="text-xs text-gray-500 mt-3">Using estimates until live data loads.</p>
        <p class="text-xs text-gray-500 mt-1">
          Live BTC fee data source:
          <a href="https://mempool.space/" target="_blank" rel="noopener noreferrer" class="text-brand-300 hover:text-brand-200 underline">mempool.space API</a>
        </p>
      </article>

      <article class="p-6 md:p-8 border border-dark-700 rounded-xl">
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left">
            <thead>
              <tr class="text-gray-400 border-b border-dark-700">
                <th class="py-3 pr-3">Network</th>
                <th class="py-3 pr-3">Fee (USD)</th>
                <th class="py-3 pr-3">You deposit</th>
                <th class="py-3 pr-3">You play with</th>
                <th class="py-3">Lost %</th>
              </tr>
            </thead>
            <tbody id="fee-table-body">
              <tr data-network="BTC" class="border-b border-dark-800">
                <td class="py-3 pr-3">Bitcoin (BTC)</td>
                <td class="py-3 pr-3">
                  $ <input id="btc-fee-input" type="number" value="6.00" min="0" step="0.1" aria-label="Bitcoin fee in USD" class="fee-input w-24 rounded border border-dark-700 bg-dark-900 px-2 py-1 text-white" />
                  <div id="btc-details" class="text-xs text-gray-500 mt-1">Estimated default</div>
                </td>
                <td class="deposit-amt py-3 pr-3">$100</td>
                <td class="play-amt py-3 pr-3 text-white">--</td>
                <td class="fee-percent py-3">--</td>
              </tr>
              <tr data-network="LTC" class="border-b border-dark-800">
                <td class="py-3 pr-3">Litecoin (LTC)</td>
                <td class="py-3 pr-3">$ <input type="number" value="0.05" min="0" step="0.01" aria-label="Litecoin fee in USD" class="fee-input w-24 rounded border border-dark-700 bg-dark-900 px-2 py-1 text-white" /></td>
                <td class="deposit-amt py-3 pr-3">$100</td>
                <td class="play-amt py-3 pr-3 text-white">--</td>
                <td class="fee-percent py-3">--</td>
              </tr>
              <tr data-network="ERC20" class="border-b border-dark-800">
                <td class="py-3 pr-3">Ethereum (ERC20)</td>
                <td class="py-3 pr-3">$ <input type="number" value="4.50" min="0" step="0.1" aria-label="Ethereum ERC20 fee in USD" class="fee-input w-24 rounded border border-dark-700 bg-dark-900 px-2 py-1 text-white" /></td>
                <td class="deposit-amt py-3 pr-3">$100</td>
                <td class="play-amt py-3 pr-3 text-white">--</td>
                <td class="fee-percent py-3">--</td>
              </tr>
              <tr data-network="TRC20">
                <td class="py-3 pr-3">Tron (TRC20)</td>
                <td class="py-3 pr-3">$ <input type="number" value="1.00" min="0" step="0.1" aria-label="Tron TRC20 fee in USD" class="fee-input w-24 rounded border border-dark-700 bg-dark-900 px-2 py-1 text-white" /></td>
                <td class="deposit-amt py-3 pr-3">$100</td>
                <td class="play-amt py-3 pr-3 text-white">--</td>
                <td class="fee-percent py-3">--</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="mt-6 border-l-2 border-brand-400 pl-4">
          <p class="text-sm text-brand-300 font-semibold mb-1">Recommendation</p>
          <p id="fee-recommendation" class="text-sm text-gray-300">--</p>
        </div>

        <p class="text-xs text-gray-500 mt-4">
          Informational estimate only. Exact fees depend on wallet, exchange, and network conditions.
        </p>
      </article>

      <article class="p-6 md:p-8 border border-dark-700 rounded-xl bg-dark-800">
        <h2 class="text-2xl font-bold text-white mb-2">{ui.whereToPlay}</h2>
        <p class="text-gray-400 text-sm mb-2">{ui.availabilityNote}</p>
        <p class="text-gray-500 text-xs mb-2">{ui.availabilityWarning}</p>
        <p class="text-gray-500 text-xs mb-6">{cta.affiliateDisclosure}</p>

        <div class="grid gap-4 md:grid-cols-2">
          {casinos.map((casinoKey) => (
            <AffiliateCard
              casinoKey={casinoKey}
              locale={locale}
              href={`/go/${casinoKey}`}
              ctaLabel={cta.seeAvailability}
            />
          ))}
        </div>
      </article>
    </div>
  </section>
</Layout>

<script>
  const BTC_CACHE_KEY = 'rbb:btc-fee-cache:en';
  const BTC_CACHE_TTL_MS = 5 * 60 * 1000;

  const formatNumber = (value: number, digits = 0) =>
    new Intl.NumberFormat('en-US', {
      maximumFractionDigits: digits,
      minimumFractionDigits: digits
    }).format(value);

  const updateCalculations = () => {
    const deposit = Math.max(1, Number.parseFloat((document.getElementById('deposit-amount') as HTMLInputElement).value) || 0);
    const rows = document.querySelectorAll('#fee-table-body tr');

    let best = { net: -Infinity, network: '', percent: 0 };

    rows.forEach((row) => {
      (row.querySelector('.deposit-amt') as HTMLElement).textContent = `$${formatNumber(deposit)}`;

      const feeInput = row.querySelector('.fee-input') as HTMLInputElement;
      const fee = Math.max(0, Number.parseFloat(feeInput.value) || 0);
      const net = Math.max(0, deposit - fee);
      const percent = deposit > 0 ? (fee / deposit) * 100 : 0;

      (row.querySelector('.play-amt') as HTMLElement).textContent = `$${formatNumber(net, 2)}`;

      const pctCell = row.querySelector('.fee-percent') as HTMLElement;
      pctCell.textContent = `${formatNumber(percent, 2)}%`;
      pctCell.classList.remove('text-red-400', 'text-green-400', 'text-gray-400');
      if (percent > 10) pctCell.classList.add('text-red-400');
      else if (percent < 2) pctCell.classList.add('text-green-400');
      else pctCell.classList.add('text-gray-400');

      if (net > best.net) {
        best = { net, network: row.getAttribute('data-network') ?? '', percent };
      }
    });

    const rec = document.getElementById('fee-recommendation') as HTMLElement;
    if (best.percent > 5) {
      rec.textContent = `Fees are high right now. Even with ${best.network}, you lose ${formatNumber(best.percent, 1)}% on this deposit size.`;
    } else {
      rec.textContent = `Use ${best.network} to maximize play money. You keep $${formatNumber(best.net, 2)} from $${formatNumber(deposit)}.`;
    }
  };

  const fetchJsonWithTimeout = async (url: string, timeoutMs: number) => {
    const controller = new AbortController();
    const timeout = window.setTimeout(() => controller.abort(), timeoutMs);
    try {
      const response = await fetch(url, { signal: controller.signal });
      return response;
    } finally {
      window.clearTimeout(timeout);
    }
  };

  const readCachedBtc = () => {
    try {
      const raw = localStorage.getItem(BTC_CACHE_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw) as { feeUsd: number; satByte: number; btcPrice: number; ts: number };
      if (!Number.isFinite(parsed.feeUsd) || !Number.isFinite(parsed.ts)) return null;
      return parsed;
    } catch {
      return null;
    }
  };

  const writeCachedBtc = (feeUsd: number, satByte: number, btcPrice: number) => {
    try {
      localStorage.setItem(
        BTC_CACHE_KEY,
        JSON.stringify({ feeUsd, satByte, btcPrice, ts: Date.now() }),
      );
    } catch {
      // Ignore storage quota/privacy mode failures.
    }
  };

  const fetchLiveBtcFee = async () => {
    const button = document.getElementById('refresh-fees') as HTMLButtonElement;
    const status = document.getElementById('last-updated') as HTMLElement;
    const btcInput = document.getElementById('btc-fee-input') as HTMLInputElement;
    const btcDetails = document.getElementById('btc-details') as HTMLElement;

    button.disabled = true;
    button.textContent = 'Fetching...';

    try {
      const [priceRes, feeRes] = await Promise.all([
        fetchJsonWithTimeout('https://mempool.space/api/v1/prices', 8000),
        fetchJsonWithTimeout('https://mempool.space/api/v1/fees/recommended', 8000)
      ]);

      if (!priceRes.ok || !feeRes.ok) {
        throw new Error('Live fee fetch failed');
      }

      const priceData = await priceRes.json() as { USD?: number };
      const feeData = await feeRes.json() as { halfHourFee?: number };

      const btcPrice = Number(priceData.USD);
      const satByte = Number(feeData.halfHourFee);
      if (!Number.isFinite(btcPrice) || !Number.isFinite(satByte)) {
        throw new Error('Invalid fee response');
      }

      const txSizeVbytes = 140;
      const feeUsd = ((satByte * txSizeVbytes) / 100000000) * btcPrice;

      btcInput.value = feeUsd.toFixed(2);
      btcDetails.textContent = `${formatNumber(satByte, 0)} sat/vB at BTC ~$${formatNumber(btcPrice, 0)}`;
      status.textContent = `Updated ${new Date().toLocaleTimeString()}`;
      writeCachedBtc(feeUsd, satByte, btcPrice);
    } catch {
      const cached = readCachedBtc();
      if (cached && Date.now() - cached.ts <= BTC_CACHE_TTL_MS) {
        btcInput.value = cached.feeUsd.toFixed(2);
        btcDetails.textContent = `${formatNumber(cached.satByte, 0)} sat/vB at BTC ~$${formatNumber(cached.btcPrice, 0)} (cached)`;
        status.textContent = 'Live fetch failed. Using recent cached values.';
      } else {
        status.textContent = 'Live fetch failed. Using manual/estimated values.';
        btcDetails.textContent = 'Could not load mempool.space data';
      }
    } finally {
      button.disabled = false;
      button.textContent = 'Refresh live BTC fee';
      updateCalculations();
    }
  };

  document.querySelectorAll('.fee-input').forEach((input) => {
    input.addEventListener('input', updateCalculations);
  });
  document.getElementById('deposit-amount')?.addEventListener('input', updateCalculations);
  document.getElementById('refresh-fees')?.addEventListener('click', fetchLiveBtcFee);

  updateCalculations();
  fetchLiveBtcFee();
</script>
